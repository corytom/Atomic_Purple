#!/usr/bin/python
import re
import socket
import subprocess
import os
    # Enumerates possible attack vectors
atomic_purple_attacks = {
    # "Boot or Logon Autostart Execution": "ID:T1547",
    "Brute Force": "ID:1110",
    # "Phishing": "ID:T1660",
    # "Impair Defenses": "ID:T1562",
}

    # Enumerates defense possibilities for various attacks
atomic_purple_defense = {
    # "M1047 Audit: Routinely check account role permissions to ensure only expected users and roles have permission to modify defensive tools and settings.",
    # "M1038 Execution Prevention: Use application control where appropriate, especially regarding the execution of tools outside of the organization's security policies (such as rootkit removal tools) that have been abused to impair system defenses. Ensure that only approved security applications are used and running on enterprise systems.",
    # "M1022 Restrict File and Directory Permissions: Ensure proper process and file permissions are in place to prevent adversaries from disabling or interfering with security/logging services.",
    # "M1024 Restrict Registry Permissions: Ensure proper Registry permissions are in place to prevent adversaries from disabling or interfering with security/logging services.",
    # "M1054 Software Configuration: Consider implementing policies on internal web servers, such HTTP Strict Transport Security, that enforce the use of HTTPS/network traffic encryption to prevent insecure connections.",
    # "M1018 User Account Management: Ensure proper user permissions are in place to prevent adversaries from disabling or interfering with security/logging services.",
}

    # Get IPv4 address for local machine to scan for vulnerabilities
def snortids():
    try:
        snortcommand = "sudo sbin/snort -A console -q -c /etc/snort/snort.conf"
        snortresult = subprocess.run(snortcommand, shell=True, capture_output=True, text=True)
        
        # Print the standard output (stdout) of the Snort process
        print("Snort Output:")
        print(snortresult.stdout)

        # Print the standard error (stderr) of the Snort process
        print("Snort Error Output:")
        print(snortresult.stderr)

    except Exception as e:
        print("Error:", e)


def get_ip_address():
    try:
        # Get the hostname of the system
        hostname = socket.gethostname()
        # Get the IP address associated with the hostname
        ip_address = socket.gethostbyname(hostname)
        return ip_address
    except Exception as e:
        print("Error:", e)
        return None

if __name__ == "__main__":
    ip_address = get_ip_address()
    #if ip_address:
       # print("IP Address:", ip_address)
    #else:
        #print("Failed to retrieve IP address.")

def download_and_run_nmap(ip_address):
    try:
        # Run git clone command to download files from GitHub repository
        #command = "git clone https://github.com/vulnersCom/nmap-vulners.git" 
        #if nmap-vulners 

       # subprocess.run(command, shell=True, check=True)
        # Change directory to the downloaded repository
        #os.chdir("repository")

        # Construct the Nmap command
        nmap_command = f"nmap --script nmap-vulners/ -sV {ip_address}"
        # Run the Nmap scan using subprocess
        nmap_result = subprocess.run(nmap_command, shell=True, capture_output=True, text=True)
        # Print the Nmap scan output
        print("Nmap Scan Result:")
        print(nmap_result.stdout)
    except Exception as e:
        print("Error:", e)


    # Log file to search for failed logins
log_file = "/var/log/auth.log"

    # Login failure scan using /var/log/ file defined above
def failed_login(log_file):
    with open(log_file, "r") as file:
            # /var/log/auth.log uses "authentication failure" to indicate failed login. Use that to find events where that occurred
        pattern = r"authentication failure" 
        regex = re.compile(pattern)

            # Start failed attempts counter
        failed_attempts = 0
            # Search line by line for pattern listed above. If present, increment counter by 1
        for line in file:
            if regex.search(line):
                failed_attempts += 1
                    
        print(f"Number of failed login attempts: {failed_attempts}")

    # Main function, asks user for attack name and provides defense options
def atomic_purple():
        #Asks user for attack to search for, gives opportunity to exit
    userinput = input("Enter the attack or defense (or type 'exit' to quit): ")
    if userinput == 'exit':
        print("Exiting the program!!")
    
    elif userinput.lower() == "stealth attack":
        answer2 = input("Would you like to enable snort IDS.(yes/no)")
        if answer2.lower == "yes":
            snortids(snortresult) 

    
    elif userinput.lower() == "dos":
        answer1 = input("Would you like to scan for vulnerabilities(yes/no)")
        if answer1.lower() == "yes":
            download_and_run_nmap(ip_address)
        
    elif userinput.lower() == "brute force":
                # Brute force commonly involves multiple login attempts, checking logs is detection strategy
        answer = input("Would you like to check for failed logins (yes/no):")
                # Runs failed login function described above, detects 10 or more failed logins in /var/log/auth.log
        if answer.lower() == "yes":
                failed_login(log_file)
        else: 
            print("no function called")
        # elif userinput in atomic_purple_attacks:
            # print("Defense for", userinput, "is", atomic_purple_attacks[userinput])
        # elif userinput in atomic_purple_defense:
            # print("Attack for", userinput, "is", atomic_purple_defense[userinput])
            #else:
                #print("Attack not found, enter valid attack")

# Test the function
atomic_purple()
